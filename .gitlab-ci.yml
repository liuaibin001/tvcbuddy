# GitLab CI/CD 配置文件 - Tauri 应用自动构建
# 支持 Windows、Linux、macOS 多平台构建

stages:
  - build
  - release

variables:
  # Rust 缓存配置
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  # pnpm 缓存
  PNPM_HOME: ${CI_PROJECT_DIR}/.pnpm

# Windows 构建
build:windows:
  stage: build
  tags:
    - windows
  before_script:
    # 安装 Node.js (如果 runner 没有)
    - choco install nodejs -y --version=20.11.0
    # 安装 pnpm
    - npm install -g pnpm
    # 安装 Rust (如果 runner 没有)
    # - choco install rust -y
  script:
    # 安装依赖
    - pnpm install
    # 构建应用
    - pnpm tauri build
  artifacts:
    name: "TVCBuddy-Windows-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 30 days
  cache:
    key: ${CI_COMMIT_REF_SLUG}-windows
    paths:
      - node_modules/
      - .cargo/
      - src-tauri/target/
      - .pnpm/
  only:
    - main
    - tags

# Linux 构建
build:linux:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker
  before_script:
    # 更新包管理器
    - apt-get update
    # 安装系统依赖
    - apt-get install -y curl wget build-essential libssl-dev pkg-config
    # 安装 Tauri 依赖
    - apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
    # 安装 Node.js
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    # 安装 pnpm
    - npm install -g pnpm
    # 安装 Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    # 安装依赖
    - pnpm install
    # 构建应用
    - pnpm tauri build
  artifacts:
    name: "TVCBuddy-Linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 30 days
  cache:
    key: ${CI_COMMIT_REF_SLUG}-linux
    paths:
      - node_modules/
      - .cargo/
      - src-tauri/target/
      - .pnpm/
  only:
    - main
    - tags

# macOS 构建
build:macos:
  stage: build
  tags:
    - macos
  before_script:
    # 安装 Homebrew (如果没有)
    # - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # 安装 Node.js
    - brew install node@20
    # 安装 pnpm
    - npm install -g pnpm
    # 安装 Rust (如果没有)
    # - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  script:
    # 安装依赖
    - pnpm install
    # 构建应用
    - pnpm tauri build
  artifacts:
    name: "TVCBuddy-macOS-$CI_COMMIT_SHORT_SHA"
    paths:
      - src-tauri/target/release/bundle/dmg/*.dmg
      - src-tauri/target/release/bundle/macos/*.app
    expire_in: 30 days
  cache:
    key: ${CI_COMMIT_REF_SLUG}-macos
    paths:
      - node_modules/
      - .cargo/
      - src-tauri/target/
      - .pnpm/
  only:
    - main
    - tags

# 发布到 GitLab Releases (仅在 tag 时触发)
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for tag $CI_COMMIT_TAG"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: 'TVCBuddy $CI_COMMIT_TAG'
    tag_name: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Windows MSI Installer'
          url: '${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:windows'
        - name: 'Linux DEB Package'
          url: '${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:linux'
        - name: 'macOS DMG'
          url: '${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:macos'
  dependencies:
    - build:windows
    - build:linux
    - build:macos
